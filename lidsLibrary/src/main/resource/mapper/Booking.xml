<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lids.dao.BookingDao">

    <!-- 存储过程-添加新的预约记录 -->
    <select id="addNewBooking" resultType="com.lids.po.BookingRecord" statementType="CALLABLE" >
        {call add_new_booking(
        #{userId, mode=IN},
        #{spaceId, mode=IN},
        #{date, mode=IN},
        #{beginTime, mode=IN},
        #{endTime,mode=IN},
        #{application,mode=IN},
        #{id,mode=OUT,jdbcType=INTEGER}
        )}
    </select>

    <!-- 调用添加partner的存储过程 -->
    <insert id="addParnter" statementType="CALLABLE">
        {call add_partner(
        #{userId,mode=IN},
        #{recordId,mode=IN}
        )}
    </insert>

    <!-- 获取今天后的所有预约记录，参数0为今天零点的时间戳-->
    <select id="getTodayRecords" resultType="java.util.Map">
        SELECT space.`name`,`schedule`.date,schedule_slot.begin_time,booking_record.end_time,booking_record.application,booking_record.is_active,booking_record.has_check_in
        from schedule_slot
        INNER JOIN `schedule` ON schedule_slot.schedule_id=`schedule`.id
        INNER JOIN space ON `schedule`.space_id = space.id
        INNER JOIN booking_record ON schedule_slot.booking_record_id = booking_record.id
        WHERE `schedule`.date >= #{0}
        limit #{1},10
    </select>

    <!--SELECT space.`name`,`schedule`.date,schedule_slot.begin_time,booking_record.end_time,booking_record.application,booking_record.is_active,booking_record.has_check_in-->
    <!--from schedule_slot-->
    <!--INNER JOIN `schedule` ON schedule_slot.schedule_id=`schedule`.id-->
    <!--INNER JOIN space ON `schedule`.space_id = space.id-->
    <!--INNER JOIN booking_record ON schedule_slot.booking_record_id = booking_record.id-->
    <!--WHERE `schedule`.date >= CURRENT_DATE-->
    <select id="getAllTodayRecords" resultType="java.util.Map" statementType="CALLABLE">
        {call select_interested_record(
        )}
    </select>

    <select id="getTopId" resultType="java.lang.Integer">
        select MAX(id) from booking_record ORDER BY id DESC
    </select>

    <select id="getCount" resultType="java.lang.Integer">
        SELECT count(id) FROM booking_record
    </select>

    <!-- 获取当前座位的当前预约,#{0}座位id -->
    <!--SELECT * FROM booking_record-->
    <!--WHERE date = CURRENT_DATE AND CURRENT_TIME BETWEEN begin_time AND end_time-->
    <!--AND space_id = #{0}-->
    <select id="getBookingNow" resultType="com.lids.po.BookingRecord" statementType="CALLABLE">
        SELECT *
        FROM booking_record
        WHERE space_id=#{0} AND is_active=1 AND CURRENT_TIME BETWEEN begin_time AND end_time
        AND date = CURRENT_DATE
    </select>

    <!-- 获取当前时间段是否有预约 #{0}当前日期date，#{1}开始时间beginTime，#{2}结束时间endTIme,#{3}spaceId -->
    <select id="getBookingNowByTime" resultType="com.lids.po.BookingRecord">
        SELECT id FROM booking_record
        WHERE space_id = #{3} AND date = #{0}
        AND
        (
            (begin_time &lt;= #{1}AND end_time &gt;= #{2})
            OR (begin_time &gt;= #{1} AND end_time &lt;= #{2})
            OR (end_time &gt; #{1} AND end_time &lt; #{2})
            OR (begin_time &gt; #{1} AND begin_time &lt; #{2})
        )
    </select>

    <!-- 获取当前时间段用户是否有预约 #{0}当前日期date，#{1}开始时间beginTime，#{2}结束时间endTIme,#{3}userId -->
    <select id="getBookingByUserId" resultType="com.lids.po.BookingRecord">
        SELECT id FROM booking_record
        WHERE user_id = #{3} AND date = #{0}
        AND
        (
        (begin_time &lt;= #{1}AND end_time &gt;= #{2})
        OR (begin_time &gt;= #{1} AND end_time &lt;= #{2})
        OR (end_time &gt; #{1} AND end_time &lt; #{2})
        OR (begin_time &gt; #{1} AND begin_time &lt; #{2})
        )
    </select>

    <!-- 根据Id获取预定记录，#{0}id -->
    <select id="getBookingRecordById" resultType="com.lids.po.BookingRecord">
        SELECT * FROM booking_record
        WHERE id = #{0}
    </select>

    <update id="setCredit">
        UPDATE booking_record
        SET has_default=1
        WHERE id=#{0};
    </update>

</mapper>